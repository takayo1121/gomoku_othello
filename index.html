<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>五目オセロ（交点ルール / 危険手切替）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",sans-serif;
    background:#f5f5f5;margin:0;padding:12px;
  }
  #status{font-weight:700;margin-bottom:8px}
  .controls{margin-bottom:10px}
  button,select{
    font-size:14px;margin-right:6px;padding:6px 10px
  }

  .board{
    width:min(92vw,520px);
    aspect-ratio:1/1;
    display:grid;
    grid-template-columns:repeat(9,1fr);
    background:#0a6a3a;
    border:2px solid #222;
  }

  .pt{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    user-select:none;
  }
  .pt::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)) center/100% 1px no-repeat,
      linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.35)) center/1px 100% no-repeat;
  }
  .disabled{ cursor:not-allowed; opacity:.35; }

  .disc{
    width:62%;height:62%;
    border-radius:50%;
    box-shadow:0 2px 8px rgba(0,0,0,.35);
    border:1px solid rgba(0,0,0,.25);
    position:relative;z-index:3;
  }
  .black{background:#000;}
  .white{background:#fff;}

  .dot{
    width:10%;height:10%;
    border-radius:50%;
    background:rgba(0,0,0,.35);
    position:relative;z-index:2;
  }

  .danger-fill{
    width:62%;height:62%;
    border-radius:50%;
    position:absolute;
    z-index:2;
    opacity:.9;
  }
  .danger-red{ background:rgba(220,0,0,.95); }
  .danger-blue{ background:rgba(0,90,255,.92); }

  .note{font-size:12px;opacity:.85;line-height:1.5;margin-top:8px}
</style>
</head>

<body>
  <div id="status"></div>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="restartBtn">リスタート</button>

    <select id="mode">
      <option value="pvp">人 vs 人</option>
      <option value="cpu">人 vs CPU（CPU=白）</option>
    </select>

    <!-- 追加：危険手 ON/OFF -->
    <button id="dangerToggleBtn">危険手：ON</button>
  </div>

  <div id="board" class="board"></div>

  <div class="note">
    危険手（塗り丸）：今そこに置くと、次の相手番で相手が即五連で勝てる可能性がある手。<br>
    白番＝赤、黒番＝青（表示は ON/OFF 切替可）
  </div>

<script>
(() => {
  const N=9, PLAY_MIN=1, PLAY_MAX=7;
  const EMPTY=0, BLACK=1, WHITE=2;
  const dirs=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
  const checkDirs=[[1,0],[0,1],[1,1],[1,-1]];

  let board, turn, gameOver, history;
  let showDanger = true; // ★ 追加：危険手表示フラグ

  const $board=document.getElementById("board");
  const $status=document.getElementById("status");
  const $mode=document.getElementById("mode");
  const $dangerBtn=document.getElementById("dangerToggleBtn");

  function init(){
    board=Array.from({length:N},()=>Array(N).fill(EMPTY));
    turn=BLACK; gameOver=false; history=[];
    render(); updateStatus();
  }
  const opp=c=>c===BLACK?WHITE:BLACK;
  const inB=(r,c)=>r>=0&&r<N&&c>=0&&c<N;
  const playable=(r,c)=>r>=PLAY_MIN&&r<=PLAY_MAX&&c>=PLAY_MIN&&c<=PLAY_MAX;
  const clone=b=>b.map(r=>r.slice());

  function flips(b,r,c,col){
    let f=[];
    for(const[dR,dC]of dirs){
      let x=r+dR,y=c+dC,tmp=[];
      while(inB(x,y)&&b[x][y]===opp(col)){tmp.push([x,y]);x+=dR;y+=dC;}
      if(tmp.length&&inB(x,y)&&b[x][y]===col)f=f.concat(tmp);
    }
    return f;
  }

  function sim(b,r,c,col){
    if(!playable(r,c)||b[r][c]!==EMPTY) return null;
    const nb=clone(b); nb[r][c]=col;
    flips(nb,r,c,col).forEach(p=>nb[p[0]][p[1]]=col);
    return nb;
  }

  function hasFive(b,col){
    for(let r=PLAY_MIN;r<=PLAY_MAX;r++)for(let c=PLAY_MIN;c<=PLAY_MAX;c++){
      if(b[r][c]!==col)continue;
      for(const[dR,dC]of checkDirs){
        let n=1,x=r+dR,y=c+dC;
        while(inB(x,y)&&b[x][y]===col){if(++n>=5)return true;x+=dR;y+=dC;}
      }
    }
    return false;
  }

  function legal(b){
    let m=[];
    for(let r=PLAY_MIN;r<=PLAY_MAX;r++)for(let c=PLAY_MIN;c<=PLAY_MAX;c++)
      if(b[r][c]===EMPTY)m.push([r,c]);
    return m;
  }

  function dangerMoves(b,col){
    const set=new Set(), o=opp(col);
    for(const[r,c]of legal(b)){
      const nb=sim(b,r,c,col);
      if(!nb||hasFive(nb,col))continue;
      for(const[x,y]of legal(nb)){
        const nb2=sim(nb,x,y,o);
        if(nb2&&hasFive(nb2,o)){set.add(`${r},${c}`);break;}
      }
    }
    return set;
  }

  function move(r,c){
    if(gameOver||!playable(r,c)||board[r][c]!==EMPTY)return;
    history.push({board:clone(board),turn,gameOver});
    board[r][c]=turn;
    flips(board,r,c,turn).forEach(p=>board[p[0]][p[1]]=turn);
    if(hasFive(board,turn)){gameOver=true;render();updateStatus(turn===BLACK?"黒の勝ち":"白の勝ち");return;}
    turn=opp(turn); render(); updateStatus();
  }

  function render(){
    const dangers = (!gameOver && showDanger) ? dangerMoves(board,turn) : new Set();
    const dClass = turn===WHITE?"danger-red":"danger-blue";
    $board.innerHTML="";
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      const cell=document.createElement("div");
      cell.className="pt"+(playable(r,c)?"":" disabled");
      cell.onclick=()=>move(r,c);
      if(board[r][c]){
        const d=document.createElement("div");
        d.className="disc "+(board[r][c]===BLACK?"black":"white");
        cell.appendChild(d);
      }else if(playable(r,c)){
        if(showDanger && dangers.has(`${r},${c}`)){
          const df=document.createElement("div");
          df.className="danger-fill "+dClass;
          cell.appendChild(df);
        }
        const dot=document.createElement("div"); dot.className="dot"; cell.appendChild(dot);
      }
      $board.appendChild(cell);
    }
  }

  function updateStatus(){
    $status.textContent = gameOver ? "ゲーム終了" :
      (turn===BLACK?"黒の手番":"白の手番");
  }

  document.getElementById("undoBtn").onclick=()=>{
    if(!history.length)return;
    const s=history.pop(); board=clone(s.board); turn=s.turn; gameOver=s.gameOver;
    render(); updateStatus();
  };
  document.getElementById("restartBtn").onclick=init;

  // ★ 危険手 ON/OFF
  $dangerBtn.onclick=()=>{
    showDanger=!showDanger;
    $dangerBtn.textContent="危険手："+(showDanger?"ON":"OFF");
    render();
  };

  init();
})();
</script>
</body>
</html>
