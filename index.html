<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>五目オセロ（交点 / 安全手OFF / CPU先後選択）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",sans-serif;
    background:#f5f5f5;margin:0;padding:12px;
  }
  #status{font-weight:700;margin-bottom:8px}
  .controls{margin-bottom:10px}
  button,select{font-size:14px;margin-right:6px;padding:6px 10px}

  .board{
    width:min(92vw,520px);
    aspect-ratio:1/1;
    display:grid;
    grid-template-columns:repeat(9,1fr);
    background:#0a6a3a;
    border:2px solid #222;
  }

  .pt{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    user-select:none;
    touch-action:manipulation;
  }
  .pt::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)) center/100% 1px no-repeat,
      linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.35)) center/1px 100% no-repeat;
    opacity:.9;
  }

  .disabled{ cursor:not-allowed; opacity:.35; }

  .disc{
    width:62%;
    height:62%;
    border-radius:50%;
    box-shadow:0 2px 8px rgba(0,0,0,.35);
    border:1px solid rgba(0,0,0,.25);
    position:relative;
    z-index:3;
  }
  .black{background:#000;}
  .white{background:#fff;}

  .dot{
    width:10%;
    height:10%;
    border-radius:50%;
    background:rgba(0,0,0,.35);
    position:relative;
    z-index:2;
  }

  /* 安全手（表示ON時のみ） */
  .safe-fill{
    width:62%;
    height:62%;
    border-radius:50%;
    position:absolute;
    z-index:2;
    opacity:.85;
    box-shadow:0 2px 8px rgba(0,0,0,.22);
  }
  .safe-blue{ background:rgba(0,90,255,.92); } /* 黒番 */
  .safe-red{  background:rgba(220,0,0,.92); } /* 白番 */

  .note{font-size:12px;opacity:.85;line-height:1.5;margin-top:8px}
</style>
</head>

<body>
  <div id="status">準備中…</div>

  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="restartBtn">リスタート</button>

    <select id="mode">
      <option value="pvp">人 vs 人</option>
      <option value="cpu">人 vs CPU</option>
    </select>

    <!-- CPU戦のときだけ表示 -->
    <select id="humanColor" title="CPU戦：あなたの色" style="display:none">
      <option value="black">あなた：黒（先手）</option>
      <option value="white">あなた：白（後手）</option>
    </select>

    <button id="safeToggleBtn">安全手：OFF</button>
  </div>

  <div id="board" class="board"></div>

  <div class="note">
    安全手（塗り丸）：今そこに置いても、次の相手番で相手が即五連で勝てない手。<br>
    表示色：黒番＝青、白番＝赤（初期状態はOFF）<br>
    CPU戦では<strong>CPU番の安全手は表示しません</strong>。
  </div>

<script>
(() => {
  const N=9, PLAY_MIN=1, PLAY_MAX=7;
  const EMPTY=0, BLACK=1, WHITE=2;
  const dirs=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
  const checkDirs=[[1,0],[0,1],[1,1],[1,-1]];

  let board, turn, gameOver, history;
  let showSafe = false; // デフォルトOFF

  const $board=document.getElementById("board");
  const $status=document.getElementById("status");
  const $mode=document.getElementById("mode");
  const $humanColor=document.getElementById("humanColor");
  const $safeBtn=document.getElementById("safeToggleBtn");

  const opp=c=>c===BLACK?WHITE:BLACK;
  const inB=(r,c)=>r>=0&&r<N&&c>=0&&c<N;
  const playable=(r,c)=>r>=PLAY_MIN&&r<=PLAY_MAX&&c>=PLAY_MIN&&c<=PLAY_MAX;
  const clone=b=>b.map(r=>r.slice());

  const isCpuMode=()=> $mode.value==="cpu";
  const human=()=> $humanColor.value==="black"?BLACK:WHITE;
  const cpu=()=> opp(human());
  const isHumanTurn=()=> !isCpuMode() || turn===human();

  function updateHumanColorVisibility(){
    $humanColor.style.display = isCpuMode() ? "" : "none";
  }

  function init(){
    board=Array.from({length:N},()=>Array(N).fill(EMPTY));
    turn=BLACK; gameOver=false; history=[];
    updateHumanColorVisibility();
    render(); updateStatus(); maybeCpu();
  }

  function flips(b,r,c,col){
    let f=[];
    for(const[dR,dC]of dirs){
      let x=r+dR,y=c+dC,tmp=[];
      while(inB(x,y)&&b[x][y]===opp(col)){tmp.push([x,y]);x+=dR;y+=dC;}
      if(tmp.length&&inB(x,y)&&b[x][y]===col)f=f.concat(tmp);
    }
    return f;
  }

  function sim(b,r,c,col){
    if(!playable(r,c)||b[r][c]!==EMPTY)return null;
    const nb=clone(b); nb[r][c]=col;
    flips(nb,r,c,col).forEach(p=>nb[p[0]][p[1]]=col);
    return nb;
  }

  function hasFive(b,col){
    for(let r=PLAY_MIN;r<=PLAY_MAX;r++)for(let c=PLAY_MIN;c<=PLAY_MAX;c++){
      if(b[r][c]!==col)continue;
      for(const[dR,dC]of checkDirs){
        let n=1,x=r+dR,y=c+dC;
        while(inB(x,y)&&b[x][y]===col){if(++n>=5)return true;x+=dR;y+=dC;}
      }
    }
    return false;
  }

  function legal(b){
    let m=[];
    for(let r=PLAY_MIN;r<=PLAY_MAX;r++)for(let c=PLAY_MIN;c<=PLAY_MAX;c++)
      if(b[r][c]===EMPTY)m.push([r,c]);
    return m;
  }

  function safeMoves(b,col){
    const set=new Set(), o=opp(col);
    for(const[r,c]of legal(b)){
      const nb=sim(b,r,c,col);
      if(!nb)continue;
      if(hasFive(nb,col)){ set.add(`${r},${c}`); continue; }
      let oppWin=false;
      for(const[x,y]of legal(nb)){
        const nb2=sim(nb,x,y,o);
        if(nb2&&hasFive(nb2,o)){ oppWin=true; break; }
      }
      if(!oppWin)set.add(`${r},${c}`);
    }
    return set;
  }

  function move(r,c){
    if(gameOver||!playable(r,c)||board[r][c]!==EMPTY)return;
    if(isCpuMode()&&!isHumanTurn())return;

    history.push({board:clone(board),turn,gameOver});
    board[r][c]=turn;
    flips(board,r,c,turn).forEach(p=>board[p[0]][p[1]]=turn);

    if(hasFive(board,turn)){ gameOver=true; render(); updateStatus(`${turn===BLACK?"黒":"白"}の勝ち！`); return; }
    turn=opp(turn); render(); updateStatus(); maybeCpu();
  }

  function chooseCpu(){
    const m=legal(board);
    for(const[r,c]of m){ const nb=sim(board,r,c,cpu()); if(nb&&hasFive(nb,cpu()))return[r,c]; }
    for(const[r,c]of m){ const nb=sim(board,r,c,human()); if(nb&&hasFive(nb,human()))return[r,c]; }
    return m.sort((a,b)=> (Math.abs(a[0]-4)+Math.abs(a[1]-4))-(Math.abs(b[0]-4)+Math.abs(b[1]-4)))[0];
  }

  function maybeCpu(){
    if(!isCpuMode()||gameOver||turn!==cpu())return;
    setTimeout(()=>{
      history.push({board:clone(board),turn,gameOver});
      const[r,c]=chooseCpu();
      board[r][c]=turn;
      flips(board,r,c,turn).forEach(p=>board[p[0]][p[1]]=turn);
      if(hasFive(board,turn)){ gameOver=true; render(); updateStatus(`${turn===BLACK?"黒":"白"}の勝ち！`); return; }
      turn=opp(turn); render(); updateStatus();
    },220);
  }

  function updateStatus(msg){
    if(msg){$status.textContent=msg;return;}
    if(gameOver){$status.textContent="ゲーム終了";return;}
    if(!isCpuMode()){$status.textContent=turn===BLACK?"黒の手番":"白の手番";return;}
    $status.textContent=`手番：${turn===BLACK?"黒":"白"}${isHumanTurn()?"（あなた）":"（CPU）"}`;
  }

  function render(){
    const show = showSafe && !gameOver && (!isCpuMode()||isHumanTurn());
    const safes = show ? safeMoves(board,turn) : new Set();
    const cls = turn===WHITE?"safe-red":"safe-blue";

    $board.innerHTML="";
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      const cell=document.createElement("div");
      cell.className="pt"+(playable(r,c)?"":" disabled");
      cell.onclick=()=>move(r,c);

      if(board[r][c]){
        const d=document.createElement("div");
        d.className="disc "+(board[r][c]===BLACK?"black":"white");
        cell.appendChild(d);
      }else if(playable(r,c)){
        if(show&&safes.has(`${r},${c}`)){
          const sf=document.createElement("div");
          sf.className="safe-fill "+cls;
          cell.appendChild(sf);
        }
        const dot=document.createElement("div"); dot.className="dot"; cell.appendChild(dot);
      }
      $board.appendChild(cell);
    }
  }

  document.getElementById("undoBtn").onclick=()=>{
    if(!history.length)return;
    const s=history.pop(); board=clone(s.board); turn=s.turn; gameOver=s.gameOver;
    render(); updateStatus();
    if(isCpuMode()&&!isHumanTurn()&&history.length){
      const s2=history.pop(); board=clone(s2.board); turn=s2.turn; gameOver=s2.gameOver;
      render(); updateStatus();
    }
  };
  document.getElementById("restartBtn").onclick=init;
  $mode.onchange=init;
  $humanColor.onchange=init;

  $safeBtn.onclick=()=>{
    showSafe=!showSafe;
    $safeBtn.textContent="安全手："+(showSafe?"ON":"OFF");
    render();
  };

  init();
})();
</script>
</body>
</html>
